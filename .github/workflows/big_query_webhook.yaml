name: GCP Cloud Functions Deployment for big-query-webhook
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    environment: dev # Fetches the env variables for dev
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          create_credentials_file: true
          token_format : "access_token"
          workload_identity_provider: '${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ secrets.SERVICE_ACCOUNT }}'
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      - name: Deploy Cloud Function
        run: |
          gcloud functions deploy big-query-webhook \
            --gen2 \
            --region us-central1 \
            --runtime python311 \
            --set-build-env-vars project_id=du-labs , dataset_name=test_dataset, table_name=test_table \
            --trigger-http \
            --source 'cloud_functions/big_query_webhook' \
            --entry-point trigger_bq
